<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö—Ç—ë—Ä: –î–æ–±—ã—á–∞ –†–µ–¥–∫–∏—Ö –ú–µ—Ç–∞–ª–ª–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #001122, #000011);
            color: white;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        #game {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100vw;
        }
        #canvas {
            flex: 1;
            background: #111;
            border-bottom: 2px solid #333;
            touch-action: none;
        }
        #ui {
            padding: 10px;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .stat {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: bold;
        }
        #digBtn {
            background: linear-gradient(45deg, #ffaa00, #ff6600);
            border: none;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            padding: 20px;
            color: white;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            box-shadow: 0 5px 15px rgba(255,170,0,0.5);
        }
        #digBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(255,170,0,0.3);
        }
        #shop {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .upgrade {
            background: rgba(0,255,0,0.2);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 10px;
            flex: 1;
            min-width: 120px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upgrade.afford { background: rgba(0,255,0,0.4); }
        .upgrade:not(.afford) { opacity: 0.5; cursor: not-allowed; }
        .upgrade:active { transform: scale(0.98); }
        .price { color: #ffd700; font-weight: bold; }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: bold;
            color: #ffd700;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            text-shadow: 2px 2px 4px #000;
            z-index: 10;
        }
        .ore {
            position: absolute;
            font-size: 40px;
            pointer-events: none;
            opacity: 0;
            transition: all 1s;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div id="game">
        <canvas id="canvas" width="400" height="300"></canvas>
        <div id="ui">
            <div class="stat">
                <span>üí∞ –ú–æ–Ω–µ—Ç—ã:</span>
                <span id="coins">0</span>
            </div>
            <div class="stat">
                <span>‚õèÔ∏è –ì–ª—É–±–∏–Ω–∞:</span>
                <span id="depth">1–º</span>
            </div>
            <div class="stat">
                <span>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:</span>
                <span id="speed">1/—Å</span>
            </div>
            <button id="digBtn">‚õèÔ∏è –ö–û–ü–ê–¢–¨! ‚õèÔ∏è</button>
            <div id="shop">
                <div class="upgrade" data-type="pickaxe">
                    <div>–ö–∏—Ä–ø–∏—á +1</div>
                    <div class="price" data-price="50">50üí∞</div>
                </div>
                <div class="upgrade" data-type="auto">
                    <div>–ê–≤—Ç–æ-–∫–æ–ø–∞—Ç–µ–ª—å</div>
                    <div class="price" data-price="200">200üí∞</div>
                </div>
                <div class="upgrade" data-type="depth">
                    <div>–ì–ª—É–±–∂–µ!</div>
                    <div class="price" data-price="1000">1000üí∞</div>
                </div>
            </div>
        </div>
        <div id="message"></div>
    </div>

    <script>
        // Telegram WebApp –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        document.body.style.background = tg.themeParams.bg_color || '#001122';
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ Telegram
        const colors = tg.themeParams;
        document.documentElement.style.setProperty('--tg-color-scheme', tg.colorScheme);
        document.documentElement.style.setProperty('--tg-bg-color', colors.bg_color);
        document.documentElement.style.setProperty('--tg-secondary-bg-color', colors.secondary_bg_color);

        // –ò–≥—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let game = {
            coins: 0,
            depth: 1,
            pickaxePower: 1,
            autoMiners: 0,
            autoPower: 1,
            lastTime: 0,
            saveInterval: 0
        };

        const ores = [
            { name: 'ü™®', value: 1, minDepth: 1, chance: 0.8 },
            { name: 'üî©', value: 5, minDepth: 5, chance: 0.5 },
            { name: 'ü•â', value: 20, minDepth: 20, chance: 0.3 },
            { name: '‚≠ê', value: 100, minDepth: 50, chance: 0.15 },
            { name: 'üíé', value: 500, minDepth: 100, chance: 0.05 }
        ];

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let canvasWidth = canvas.width;
        let canvasHeight = canvas.height;

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        function resizeCanvas() {
            canvasWidth = canvas.clientWidth;
            canvasHeight = canvas.clientHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        async function loadGame() {
            try {
                const data = await tg.CloudStorage.getItems(['gameSave']);
                if (data['gameSave']) {
                    Object.assign(game, JSON.parse(data['gameSave']));
                }
            } catch (e) {
                console.log('No cloud save, using local');
                const local = localStorage.getItem('minerSave');
                if (local) Object.assign(game, JSON.parse(local));
            }
        }
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        async function saveGame() {
            try {
                await tg.CloudStorage.setItem('gameSave', JSON.stringify(game));
            } catch (e) {
                localStorage.setItem('minerSave', JSON.stringify(game));
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ä—É–¥—É –ø–æ –≥–ª—É–±–∏–Ω–µ
        function getOre() {
            const rand = Math.random();
            let cumulative = 0;
            for (let ore of ores) {
                if (game.depth >= ore.minDepth) {
                    cumulative += ore.chance * (1 + (game.depth - ore.minDepth) / 1000);
                    if (rand < cumulative) return ore;
                }
            }
            return ores[0]; // default stone
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∫–∏
        function showOre(x, y, ore) {
            const elem = document.createElement('div');
            elem.className = 'ore';
            elem.innerHTML = ore.name;
            elem.style.left = x + 'px';
            elem.style.top = y + 'px';
            document.body.appendChild(elem);
            setTimeout(() => {
                elem.style.opacity = '1';
                elem.style.transform = 'translateY(-50px) scale(1.2)';
            }, 10);
            setTimeout(() => {
                elem.remove();
            }, 1000);
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —à–∞—Ö—Ç—ã
        function drawMine(now) {
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // –°—Ç–µ–Ω—ã —à–∞—Ö—Ç—ã
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, 50, canvasHeight);
            ctx.fillRect(canvasWidth - 50, 0, 50, canvasHeight);

            // –ó–µ–º–ª—è/—Ä—É–¥–∞
            const blockHeight = 30;
            const blocks = Math.floor(canvasHeight / blockHeight);
            for (let i = 0; i < blocks; i++) {
                const depthHere = Math.floor(game.depth - blocks + i + 1);
                ctx.fillStyle = depthHere > 0 ? '#8B4513' : '#654321';
                ctx.fillRect(50, i * blockHeight, canvasWidth - 100, blockHeight);

                // –†–µ–¥–∫–∞—è —Ä—É–¥–∞ –º–∏–≥–∞–µ—Ç
                if (Math.random() < 0.1 && depthHere > 10) {
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(60 + Math.random() * (canvasWidth - 140), i * blockHeight + 5, 20, 20);
                }
            }

            // –®–∞—Ö—Ç—ë—Ä –≤–Ω–∏–∑—É
            ctx.fillStyle = '#FFDBAC';
            ctx.beginPath();
            ctx.arc(canvasWidth / 2, canvasHeight - 40, 20, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.fillRect(canvasWidth / 2 - 5, canvasHeight - 50, 10, 20); // —Ç–µ–ª–æ
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(canvasWidth / 2 - 15, canvasHeight - 45, 30, 10); // –∫–∏—Ä–ø–∏—á

            // –ì–ª—É–±–∏–Ω–∞ —Ç–µ–∫—Å—Ç
            ctx.fillStyle = '#FFF';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`–ì–ª—É–±–∏–Ω–∞: ${game.depth}–º`, canvasWidth / 2, 40);
        }

        // –ö–ª–∏–∫ –∫–æ–ø–∞—Ç—å
        function dig() {
            const ore = getOre();
            const amount = game.pickaxePower * (1 + Math.floor(game.depth / 10));
            game.coins += ore.value * amount;
            showOre(canvasWidth / 2 - 20, canvasHeight - 100, ore);
            showMessage(`+${ore.value * amount} üí∞`);
            updateUI();
        }

        // –ê–≤—Ç–æ-–¥–æ–±—ã—á–∞
        function autoDig(dt) {
            const autoEarn = game.autoMiners * game.autoPower * dt * (1 + game.depth / 100);
            game.coins += Math.floor(autoEarn);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.style.opacity = '1';
            setTimeout(() => { msg.style.opacity = '0'; }, 1000);
        }

        // –û–±–Ω–æ–≤–∏—Ç—å UI
        function updateUI() {
            document.getElementById('coins').textContent = Math.floor(game.coins).toLocaleString();
            document.getElementById('depth').textContent = game.depth + '–º';
            document.getElementById('speed').textContent = (game.pickaxePower + game.autoMiners * game.autoPower).toFixed(1) + '/—Å';

            // –ê–ø–≥—Ä–µ–π–¥—ã
            const upgrades = document.querySelectorAll('.upgrade');
            upgrades.forEach(up => {
                const type = up.dataset.type;
                let price = 0;
                if (type === 'pickaxe') price = 50 * Math.pow(1.5, game.pickaxePower);
                else if (type === 'auto') price = 200 * Math.pow(2, game.autoMiners);
                else if (type === 'depth') price = 1000 * Math.pow(1.3, Math.floor(game.depth / 10));
                up.querySelector('.price').textContent = Math.floor(price).toLocaleString() + 'üí∞';

                if (game.coins >= price) {
                    up.classList.add('afford');
                } else {
                    up.classList.remove('afford');
                }
            });
        }

        // –ö–ª–∏–∫ –ø–æ –∞–ø–≥—Ä–µ–π–¥—É
        document.querySelectorAll('.upgrade').forEach(up => {
            up.addEventListener('click', () => {
                const type = up.dataset.type;
                let price = 0;
                if (type === 'pickaxe') {
                    price = 50 * Math.pow(1.5, game.pickaxePower);
                    if (game.coins >= price) {
                        game.coins -= price;
                        game.pickaxePower++;
                        showMessage('üõ†Ô∏è –ö–∏—Ä–ø–∏—á —É–ª—É—á—à–µ–Ω!');
                    }
                } else if (type === 'auto') {
                    price = 200 * Math.pow(2, game.autoMiners);
                    if (game.coins >= price) {
                        game.coins -= price;
                        game.autoMiners++;
                        game.autoPower += 0.5;
                        showMessage('ü§ñ –ê–≤—Ç–æ-–∫–æ–ø–∞—Ç–µ–ª—å!');
                    }
                } else if (type === 'depth') {
                    price = 1000 * Math.pow(1.3, Math.floor(game.depth / 10));
                    if (game.coins >= price) {
                        game.coins -= price;
                        game.depth += 10;
                        showMessage('‚¨áÔ∏è –°–ø—É—Å—Ç–∏–ª—Å—è –≥–ª—É–±–∂–µ!');
                    }
                }
                updateUI();
            });
        });

        // Game loop
        function gameLoop(now) {
            const dt = (now - game.lastTime) / 1000;
            game.lastTime = now;

            autoDig(dt);
            game.depth += dt * 0.1; // –ú–µ–¥–ª–µ–Ω–Ω—ã–π —Å–ø—É—Å–∫
            game.saveInterval += dt;
            if (game.saveInterval > 10) {
                saveGame();
                game.saveInterval = 0;
            }

            drawMine(now);
            updateUI();

            requestAnimationFrame(gameLoop);
        }

        // Events
        document.getElementById('digBtn').addEventListener('click', dig);
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            if (x > 50 && x < canvasWidth - 50) dig();
        });

        // Start
        loadGame().then(() => {
            updateUI();
            game.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        });
    </script>
</body>
</html>